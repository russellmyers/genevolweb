{%  extends 'common/base.html' %}
{%  load static %}
 {% block title %}
Pedigree Analyzer
{% endblock %}


{%  block app_title %}
Pedigree Analyzer
{% endblock  %}

{%  block custom_css %}
    <link href="{%  static "css/ped_an/ped_an.css" %}" rel="stylesheet">
{%  endblock custom_css %}

{%  block content %}

<div class = "container-fluid">
    <div class = "row">


        <div class = "col-1">

        </div>
        <div class = "col-10">

             <form method="GET" id="ped_form" action="{%  url 'ped_an' %}">
                <div class = "text-center">
                    <input type="submit" class="btn btn-primary" value="New Pedigree" id="new-ped_but">
                </div>
                 <br>
                <label>Find a consistent inheritance pattern  <small><span id="num-exist">hh</span></small> </label>

                 <div class = "row">
                     <div class = "col-3">
                        {{ form.inh_patterns }}
                     </div>
                    <div class = "col-1 my-auto">
                        <img  class ="tick-img" id="tick-img" src = "{%  static 'img/tick.jpg' %}" width="20px">
                    </div>
                     <div class = "col-3">
                         <button type="button" id="show-but" class="btn btn-info btn-large" onclick="showGenotypeButClicked(event);">Reveal Inferrable Genotypes</button>

                     </div>

                 </div>
             </form>
        </div>
        <div class = "col-1">

        </div>
    </div>
    <div class = "row">

            <div class = "col-1">
            </div>
            <div class = "col-10">
                <canvas id="canvas" width="500px" height = "400px" class = "mt-4">

                </canvas>
            </div>

            {%if  debug == 'Y' %}
            <div class = "col-1 border mt-4" id="pa-settings">
                <form method="GET" id="type_form" action="{%  url 'ped_an' %}">
                    {% csrf_token %}
                    <p class="lead">
                        Settings
                    </p>

                    <br>
                    <br>
                    <small>
                        <div class = "text-muted">
                            <!--span>{{  act_gens }}</span>
                            <br-->
                            {{  cons_per_inferrer }}
                            <br>
                            {{  ped_j.actual }}

                            <br>
                        </div>
                    </small>

                  </form>


            </div>
            {%endif %}


    </div>

</div>



{%  endblock %}

{%  block script %}
{{ orgs | json_script:"jOrgs" }}
{{ poss_gametes | json_script:"jPossGametes" }}
{{ poss_gametes_rolled_up | json_script:"jPossGametesRolledUp" }}
{{ gen_phen | json_script:"jGenPhen" }}
{{ num_traits | json_script:"jNumTraits" }}
{{  p1_ind | json_script:"jP1Ind"}}
{{  p2_ind | json_script:"jP2Ind"}}
{{  genome_name | json_script:"jGenomeName"}}

{{ ped_j | json_script:"jPedigree" }}

{{ act_gens | json_script:"jActGens" }}
{{  cons_per_inferrer | json_script:"jConsPerInferrer" }}


<script src="{% get_static_prefix %}js/pa/viewclasses.js"></script>
<script src="{% get_static_prefix %}js/pa/modelclasses.js"></script>
<script src="{% get_static_prefix %}js/pa/propertylisteners.js"></script>
<script src="{% get_static_prefix %}js/pa/eventlisteners.js"></script>

<script>


function fitToContainer(canvas){
  // Make it visually fill the positioned parent
  canvas.style.width ='100%';
  canvas.style.height='100%';
  // ...then set the internal size to match
  canvas.width  = canvas.offsetWidth;
  canvas.height = canvas.offsetHeight;
}

function numConsistent() {
    var numCons = 0
    for (key in consistentPerInferrer) {
        if (consistentPerInferrer[key] == 0) {

        }
        else {
            numCons +=1;
        }
    }
    return numCons;

}


var staticPrefix = "{% get_static_prefix %}"

canvasEl = document.getElementById('canvas');
var pedigreeJson = {
    'orgs':[
        {'id':1, 'sex':'male', 'afflicted':false, 'children':[3, 4, 5, 6], 'partner':2, 'level': 1, 'isInlaw':false},
        {'id':2, 'sex': 'female', 'afflicted':true, 'children':[], 'partner': null, 'level': 1, 'isInlaw':false},
        {'id':3, 'sex': 'female', 'afflicted':false, 'children':[8,9], 'partner': 7, 'level':2, 'isInlaw':false},
        {'id':4, 'sex': 'male', 'afflicted':false, 'children':[12], 'partner': 11, 'level':2, 'isInlaw':false},
        {'id':5, 'sex': 'female', 'afflicted':false, 'children':[17], 'partner': 16, 'level':2, 'isInlaw':false},
        {'id':6, 'sex': 'male', 'afflicted':false, 'children':[24, 25, 26, 27], 'partner': 23, 'level':2, 'isInlaw':true},
        {'id':7, 'sex': 'female', 'afflicted':true, 'children':[], 'partner': null, 'level':2, 'isInlaw':false},
        {'id':8, 'sex': 'female', 'afflicted':false, 'children':[], 'partner': 10, 'level':3, 'isInlaw':false},
        {'id':9, 'sex': 'male', 'afflicted':true, 'children':[], 'partner': null, 'level':3, 'isInlaw':false},
        {'id':10, 'sex': 'male', 'afflicted':true, 'children':[], 'partner': null, 'level':3, 'isInlaw':true},
        {'id':11, 'sex': 'female', 'afflicted':false, 'children':[], 'partner': null, 'level':2, 'isInlaw':true},
        {'id':12, 'sex': 'female', 'afflicted':false, 'children':[14, 15], 'partner': 13, 'level':3, 'isInlaw':false},
        {'id':13, 'sex': 'male', 'afflicted':true, 'children':[], 'partner': null, 'level':3, 'isInlaw':true},
        {'id':14, 'sex': 'female', 'afflicted':false, 'children':[], 'partner': null, 'level':4, 'isInlaw':false},
        {'id':15, 'sex': 'male', 'afflicted':true, 'children':[], 'partner': null, 'level':4, 'isInlaw':false},
        {'id':16, 'sex': 'male', 'afflicted':true, 'children':[], 'partner': null, 'level':2, 'isInlaw':true},
        {'id':17, 'sex': 'female', 'afflicted':false, 'children':[19, 20, 21, 22], 'partner': 18, 'level':3, 'isInlaw':false},
        {'id':18, 'sex': 'male', 'afflicted':true, 'children':[], 'partner': null, 'level':3, 'isInlaw':true},
        {'id':19, 'sex': 'male', 'afflicted':true, 'children':[], 'partner': null, 'level':4, 'isInlaw':false},
        {'id':20, 'sex': 'male', 'afflicted':true, 'children':[], 'partner': null, 'level':4, 'isInlaw':false},
        {'id':21, 'sex': 'female', 'afflicted':false, 'children':[], 'partner': null, 'level':4, 'isInlaw':false},
        {'id':22, 'sex': 'female', 'afflicted':false, 'children':[], 'partner': null, 'level':4, 'isInlaw':false},
        {'id':23, 'sex': 'female', 'afflicted':false, 'children':[], 'partner': null, 'level':2, 'isInlaw':true},
        {'id':24, 'sex': 'male', 'afflicted':false, 'children':[], 'partner': null, 'level':3, 'isInlaw':false},
        {'id':25, 'sex': 'female', 'afflicted':false, 'children':[], 'partner': null, 'level':3, 'isInlaw':false},
        {'id':26, 'sex': 'female', 'afflicted':false, 'children':[], 'partner': null, 'level':3, 'isInlaw':false},
        {'id':27, 'sex': 'female', 'afflicted':false, 'children':[], 'partner': null, 'level':3, 'isInlaw':false},

//        {'id':28, 'sex': 'female', 'afflicted':false, 'children':[], 'partner': null, 'level':2, 'isInlaw':false},

//        {'id':29, 'sex': 'female', 'afflicted':false, 'children':[], 'partner': null, 'level':2, 'isInlaw':false},
//        {'id':30, 'sex': 'female', 'afflicted':false, 'children':[], 'partner': null, 'level':4, 'isInlaw':false},
//        {'id':31, 'sex': 'female', 'afflicted':false, 'children':[], 'partner': null, 'level':4, 'isInlaw':false},







        ],
    'adam':1
}

pedigreeJson =  JSON.parse(document.getElementById('jPedigree').textContent);
consistentPerInferrer = JSON.parse(document.getElementById('jConsPerInferrer').textContent);



var pedigree = null;
var pd = null;

var showGenotypes = false;


window.onresize = function () {
    canvasEl = document.getElementById('canvas');
    fitToContainer(canvasEl);
    var resize = true;
    pd.drawStuff(resize);
}



window.onload = function(){
    var inhPatternsEl = document.getElementById('id_inh_patterns');
    inhPatternsEl.addEventListener('change', inhPatternSelected, false);

    var numCons = numConsistent();
    var numExistEl = document.getElementById('num-exist');
    numExistEl.innerHTML = '(' + numCons + ' consistent pattern' + (numCons == 1 ? '' : 's') + ' exist' + (numCons == 1 ? 's' : '') + ')'

    var canvasEl = document.getElementById('canvas');
    fitToContainer(canvasEl);
    pedigree = new Pedigree(pedigreeJson);
    pd = new PedigreeDiagram(pedigree,canvasEl, null);

    pd.drawStuff()

}

var orgs = JSON.parse(document.getElementById('jOrgs').textContent);
var state = 1;


</script>

{%  endblock %}